"use client"

import { useState, useEffect } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
} from "@/components/ui/dialog"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { Plus, Receipt, Search, Eye, Edit, Upload, Clock, CheckCircle, XCircle, Wallet, TrendingUp, TrendingDown, Link as LinkIcon, Building2 } from "lucide-react"
import { formatCurrency } from "@/utils/currency"
import { useLanguage } from "@/contexts/language-context"
import { useAuth } from "@/contexts/auth-context"
import { expenseRequestService, budgetCategoriesService, financialsService } from "@/lib/services"
import { EmployeeBalanceService, EmployeeBalance } from "@/lib/employee-balance-service"
import { useToast } from "@/components/ui/use-toast"
import { supabase } from "@/lib/supabase"

interface ExpenseAttachmentMeta {
  id?: string
  file_name: string
  file_size?: number
  mime_type?: string
  file_url?: string
  storage_path?: string
  uploaded_at?: string
}

interface ExpenseRequest {
  id: string
  employee_id: string
  category: string
  description: string
  amount: number
  date: string
  status: "pending" | "approved" | "rejected"
  submitted_date: string
  attachments?: string[]
  file_attachments?: ExpenseAttachmentMeta[]
  notes?: string
  approved_by?: string
  approved_date?: string
  rejected_by?: string
  rejected_date?: string
  rejection_reason?: string
  employee?: {
    id: string
    name: string
    employee_code: string
    department?: {
      name: string
    }
    position?: {
      name: string
    }
  }
  approved_by_employee?: {
    id: string
    name: string
    employee_code: string
  }
  rejected_by_employee?: {
    id: string
    name: string
    employee_code: string
  }
}

const expenseCategories = ["ƒêi l·∫°i", "ƒÇn u·ªëng", "Kh√°ch s·∫°n", "VƒÉn ph√≤ng ph·∫©m", "ƒê√†o t·∫°o", "Thi·∫øt b·ªã", "Kh√°c"]

export default function ExpensesPage() {
  const { t } = useLanguage()
  const { toast } = useToast()
  const { user } = useAuth()
  
  // Map database role to UI role for permissions
  const getUserRole = (): "Employee" | "Manager" | "HR" | "Accountant" => {
    if (!user) return "Employee"
    
    switch (user.role) {
      case 'admin':
      case 'hr':
        return "HR"
      case 'lead':
        return "Manager"
      case 'accountant':
        return "Accountant"
      case 'employee':
      default:
        return "Employee"
    }
  }
  
  const userRole = getUserRole()
  const [expenseRequests, setExpenseRequests] = useState<ExpenseRequest[]>([])
  const [searchTerm, setSearchTerm] = useState("")
  const [filterStatus, setFilterStatus] = useState<"all" | "pending" | "approved" | "rejected">("all")
  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false)
  const [isRejectDialogOpen, setIsRejectDialogOpen] = useState(false)
  const [rejectingRequestId, setRejectingRequestId] = useState<string>("")
  const [rejectionReason, setRejectionReason] = useState("")
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [approvingRequestId, setApprovingRequestId] = useState<string>("")
  const [employeeBalance, setEmployeeBalance] = useState<EmployeeBalance | null>(null)
  const [rejectingRequestIdForLoading, setRejectingRequestIdForLoading] = useState<string>("")
  const [loading, setLoading] = useState(true)

  // Form state for new expense request
  const [newRequest, setNewRequest] = useState({
    category: "",
    description: "",
    amount: "",
    date: new Date().toISOString().split("T")[0],
    notes: "",
  })
  const [newRequestFiles, setNewRequestFiles] = useState<File[]>([])

  // Form state for editing expense request
  const [editRequest, setEditRequest] = useState({
    category: "",
    description: "",
    amount: "",
    date: new Date().toISOString().split("T")[0],
    notes: "",
  })

  // Detail and edit dialogs
  const [isDetailDialogOpen, setIsDetailDialogOpen] = useState(false)
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false)
  const [selectedRequest, setSelectedRequest] = useState<ExpenseRequest | null>(null)
  const [attachmentLinks, setAttachmentLinks] = useState<Record<string, string>>({})
  const [budgetCategories, setBudgetCategories] = useState<any[]>([])
  const [isIntegrateDialogOpen, setIsIntegrateDialogOpen] = useState(false)
  const [integratingRequest, setIntegratingRequest] = useState<ExpenseRequest | null>(null)
  const [selectedBudgetCategory, setSelectedBudgetCategory] = useState<string>("")
  const [isIntegrating, setIsIntegrating] = useState(false)
  const [selectedExpenseCategory, setSelectedExpenseCategory] = useState<string>("")

  const currentUserId = user?.id || ""

  // Helper: upload files to Supabase Storage and return metadata array
  const uploadSelectedFiles = async (files: File[]): Promise<ExpenseAttachmentMeta[]> => {
    if (!files || files.length === 0) return []
    try {
      const form = new FormData()
      form.append('employee_id', currentUserId)
      files.forEach(f => form.append('files', f))
      const res = await fetch('/api/expense-requests/upload', { method: 'POST', body: form })
      if (!res.ok) throw new Error('upload_failed')
      const json = await res.json()
      return (json.files || []) as ExpenseAttachmentMeta[]
    } catch (e) {
      console.error('uploadSelectedFiles error', e)
      toast({ title: 'L·ªói upload', description: 'Kh√¥ng th·ªÉ t·∫£i t·ªáp l√™n m√°y ch·ªß', variant: 'destructive' })
      return []
    }
  }

  // Fetch expense requests
  const fetchExpenseRequests = async () => {
    try {
      setLoading(true)
      const filters: any = {}
      if (filterStatus !== "all") filters.status = filterStatus
      if (userRole === "Employee") filters.employeeId = currentUserId
      const result = await expenseRequestService.getExpenseRequests(filters)
      if (result.data) {
        setExpenseRequests(result.data)
      } else {
        toast({ title: "L·ªói", description: "Kh√¥ng th·ªÉ t·∫£i danh s√°ch y√™u c·∫ßu chi ph√≠", variant: "destructive" })
      }
      
      // Fetch employee balance if user is employee
      if (userRole === "Employee" && currentUserId) {
        try {
          const balance = await EmployeeBalanceService.getEmployeeBalance(currentUserId)
          setEmployeeBalance(balance)
        } catch (error) {
          console.error('Error fetching employee balance:', error)
        }
      }

      // Fetch budget categories for integration (only expense categories - category_type = 1)
      try {
        const categoriesResult = await budgetCategoriesService.getCategories({ tree: true })
        if (categoriesResult.data) {
          let actualData = categoriesResult.data;
          // Handle nested data structure
          if (typeof actualData === 'object' && actualData !== null && 'data' in actualData && Array.isArray((actualData as any).data)) {
            actualData = (actualData as any).data;
          }
          // Filter only expense categories (category_type = 1)
          if (Array.isArray(actualData)) {
            const expenseCategories = actualData.filter((cat: any) => cat.category_type === 1);
            console.log('‚úÖ Expense categories loaded:', expenseCategories.length, 'categories');
            setBudgetCategories(expenseCategories);
          }
        }
      } catch (error) {
        console.error('Error fetching budget categories:', error)
      }
    } catch (error) {
      toast({ title: "L·ªói", description: "ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu", variant: "destructive" })
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchExpenseRequests()
  }, [filterStatus, userRole])

  // T√≠nh to√°n th·ªëng k√™
  const totalPending = expenseRequests.filter((r) => r.status === "pending").length
  const totalApproved = expenseRequests.filter((r) => r.status === "approved").length
  const totalRejected = expenseRequests.filter((r) => r.status === "rejected").length
  const totalAmount = expenseRequests.filter((r) => r.status === "approved").reduce((sum, r) => sum + r.amount, 0)

  // L·ªçc y√™u c·∫ßu
  const filteredRequests = expenseRequests.filter((request) => {
    const matchesSearch =
      request.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
      request.employee?.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      request.category.toLowerCase().includes(searchTerm.toLowerCase())
    const matchesStatus = filterStatus === "all" || request.status === filterStatus
    return matchesSearch && matchesStatus
  })

  const handleCreateExpenseRequest = async () => {
    // Prevent duplicate submissions
    if (isSubmitting) return;
    
    try {
      setIsSubmitting(true);

      // Upload files first and get metadata
      const uploadedMetas = await uploadSelectedFiles(newRequestFiles)

      const payload = {
        employee_id: currentUserId,
        category: newRequest.category,
        description: newRequest.description,
        amount: Number(newRequest.amount),
        date: newRequest.date,
        notes: newRequest.notes || undefined,
        file_attachments: uploadedMetas,
      }
      console.log("T·∫°o y√™u c·∫ßu chi ph√≠:", payload)
      const result = await expenseRequestService.createExpenseRequest(payload as any)
      if (result.data) {
        toast({ title: "Th√†nh c√¥ng", description: "ƒê√£ t·∫°o y√™u c·∫ßu chi ph√≠ th√†nh c√¥ng" })
        fetchExpenseRequests()
        setIsAddDialogOpen(false)
        setNewRequest({
          category: "",
          description: "",
          amount: "",
          date: new Date().toISOString().split("T")[0],
          notes: "",
        })
        setNewRequestFiles([])
      } else {
        console.error("L·ªói t·∫°o y√™u c·∫ßu chi ph√≠:", result?.error)
        toast({ title: "L·ªói", description: result.error || "Kh√¥ng th·ªÉ t·∫°o y√™u c·∫ßu chi ph√≠", variant: "destructive" })
      }
    } catch (error) {
      console.error("L·ªói t·∫°o y√™u c·∫ßu chi ph√≠:", error)
      toast({ title: "L·ªói", description: "ƒê√£ c√≥ l·ªói x·∫£y ra", variant: "destructive" })
    } finally {
      setIsSubmitting(false);
    }
  }

  // Helper function to flatten budget categories for display
  const flattenCategories = (categories: any[]): any[] => {
    const result: any[] = []
    
    if (!Array.isArray(categories)) {
      return []
    }
    
    const flatten = (cats: any[], level: number = 0) => {
      cats.forEach(cat => {
        if (cat && cat.id && cat.code && cat.name) {
          result.push({
            ...cat,
            displayName: `${'  '.repeat(level)}${cat.code} - ${cat.name}`,
            level
          })
          if (cat.children && Array.isArray(cat.children) && cat.children.length > 0) {
            flatten(cat.children, level + 1)
          }
        }
      })
    }
    
    flatten(categories)
    return result
  }

  // Helper function to automatically create financial transaction when expense is approved
  const createFinancialTransactionFromExpense = async (expense: ExpenseRequest, budgetCategoryId?: string) => {
    try {
      const transactionData = {
        transaction_type: 'expense', // Always expense for expense requests
        category_id: budgetCategoryId || null, // Can be null if no category selected
        description: `Chi ph√≠: ${expense.description}`,
        amount: expense.amount,
        date: expense.date,
        account_type: 'company', // Default to company account
        notes: `T·ª± ƒë·ªông t·∫°o t·ª´ y√™u c·∫ßu chi ph√≠ #${expense.id.slice(0, 8)} - ${expense.employee?.name || 'Nh√¢n vi√™n'}`,
      }
      
      console.log('üîÑ Creating financial transaction from expense:', transactionData);
      const result = await financialsService.createTransaction(transactionData);
      
      if (result.data) {
        console.log('‚úÖ Financial transaction created successfully');
        return result.data;
      } else {
        console.error('‚ùå Failed to create financial transaction:', result.error);
        throw new Error(result.error || 'Kh√¥ng th·ªÉ t·∫°o giao d·ªãch t√†i ch√≠nh');
      }
    } catch (error) {
      console.error('‚ùå Error creating financial transaction:', error);
      throw error;
    }
  }

  const handleApprove = async (id: string) => {
    // Prevent duplicate submissions
    if (approvingRequestId === id) return;
    
    try {
      setApprovingRequestId(id);
      
      // First, approve the expense request
      const result = await expenseRequestService.approveExpenseRequest(id)
      if (result.data) {
        // Find the approved expense request
        const approvedExpense = expenseRequests.find(req => req.id === id);
        if (approvedExpense) {
          // Show integration dialog to select budget category
          setIntegratingRequest(approvedExpense);
          setIsIntegrateDialogOpen(true);
        } else {
          toast({ title: "Th√†nh c√¥ng", description: "ƒê√£ duy·ªát y√™u c·∫ßu chi ph√≠" })
          fetchExpenseRequests()
        }
      } else {
        toast({ title: "L·ªói", description: result.error || "Kh√¥ng th·ªÉ duy·ªát y√™u c·∫ßu", variant: "destructive" })
      }
    } catch (error) {
      toast({ title: "L·ªói", description: "ƒê√£ c√≥ l·ªói x·∫£y ra", variant: "destructive" })
    } finally {
      setApprovingRequestId("");
    }
  }

  const handleReject = async (id: string, reason: string) => {
    // Prevent duplicate submissions
    if (rejectingRequestIdForLoading === id) return;
    
    try {
      setRejectingRequestIdForLoading(id);
      const result = await expenseRequestService.rejectExpenseRequest(id, reason)
      if (result.data) {
        toast({ title: "Th√†nh c√¥ng", description: "ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu chi ph√≠" })
        fetchExpenseRequests()
        setIsRejectDialogOpen(false)
        setRejectionReason("")
        setRejectingRequestId("")
      } else {
        toast({ title: "L·ªói", description: result.error || "Kh√¥ng th·ªÉ t·ª´ ch·ªëi y√™u c·∫ßu", variant: "destructive" })
      }
    } catch (error) {
      toast({ title: "L·ªói", description: "ƒê√£ c√≥ l·ªói x·∫£y ra", variant: "destructive" })
    } finally {
      setRejectingRequestIdForLoading("");
    }
  }

  const openRejectDialog = (requestId: string) => {
    setRejectingRequestId(requestId)
    setIsRejectDialogOpen(true)
  }

  const openCreateDialog = () => {
    // Reset form to empty state
    setNewRequest({
      category: "",
      description: "",
      amount: "",
      date: new Date().toISOString().split("T")[0],
      notes: "",
    })
    setSelectedExpenseCategory("")
    setIsAddDialogOpen(true)
  }

  // Handle integration with financial system
  const handleIntegrateWithFinancial = async () => {
    if (!integratingRequest) {
      toast({ title: "L·ªói", description: "Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu chi ph√≠", variant: "destructive" })
      return
    }

    try {
      setIsIntegrating(true);
      
      if (selectedBudgetCategory) {
        // Create financial transaction with budget category
        await createFinancialTransactionFromExpense(integratingRequest, selectedBudgetCategory);
        
        toast({ 
          title: "Th√†nh c√¥ng", 
          description: `ƒê√£ t√≠ch h·ª£p chi ph√≠ v√†o h·ªá th·ªëng t√†i ch√≠nh v√† d·ª± to√°n ng√¢n s√°ch` 
        })
      } else {
        // Just show success message for approval without integration
        toast({ 
          title: "Th√†nh c√¥ng", 
          description: `ƒê√£ duy·ªát y√™u c·∫ßu chi ph√≠ (kh√¥ng t√≠ch h·ª£p v·ªõi ng√¢n s√°ch)` 
        })
      }
      
      // Close dialog and refresh data
      setIsIntegrateDialogOpen(false);
      setIntegratingRequest(null);
      setSelectedBudgetCategory("");
      fetchExpenseRequests();
      
    } catch (error) {
      const msg = error instanceof Error ? error.message : "ƒê√£ c√≥ l·ªói x·∫£y ra";
      toast({ title: "L·ªói", description: msg, variant: "destructive" })
    } finally {
      setIsIntegrating(false);
    }
  }

  const viewRequestDetail = (request: ExpenseRequest) => {
    setSelectedRequest(request)
    setIsDetailDialogOpen(true)
  }

  const openEditDialog = (request: ExpenseRequest) => {
    setSelectedRequest(request)
    setEditRequest({
      category: request.category,
      description: request.description,
      amount: request.amount.toString(),
      date: request.date,
      notes: request.notes || "",
    })
    setIsEditDialogOpen(true)
  }

  const openIntegrateDialog = (request: ExpenseRequest) => {
    setIntegratingRequest(request)
    setSelectedBudgetCategory("")
    setIsIntegrateDialogOpen(true)
  }

  const handleUpdateRequest = async () => {
    if (!selectedRequest) return
    
    try {
      const payload = {
        category: editRequest.category,
        description: editRequest.description,
        amount: Number(editRequest.amount),
        date: editRequest.date,
        notes: editRequest.notes || undefined,
      }
      console.log("C·∫≠p nh·∫≠t y√™u c·∫ßu chi ph√≠:", payload)
      const result = await expenseRequestService.updateExpenseRequest(selectedRequest.id, payload)
      if (result.data) {
        toast({ title: "Th√†nh c√¥ng", description: "ƒê√£ c·∫≠p nh·∫≠t y√™u c·∫ßu chi ph√≠ th√†nh c√¥ng" })
        fetchExpenseRequests()
        setIsEditDialogOpen(false)
        setSelectedRequest(null)
        setEditRequest({
          category: "",
          description: "",
          amount: "",
          date: new Date().toISOString().split("T")[0],
          notes: "",
        })
      } else {
        console.error("L·ªói c·∫≠p nh·∫≠t y√™u c·∫ßu chi ph√≠:", result?.error)
        toast({ title: "L·ªói", description: result.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t y√™u c·∫ßu chi ph√≠", variant: "destructive" })
      }
    } catch (error) {
      console.error("L·ªói c·∫≠p nh·∫≠t y√™u c·∫ßu chi ph√≠:", error)
      toast({ title: "L·ªói", description: "ƒê√£ c√≥ l·ªói x·∫£y ra", variant: "destructive" })
    }


  const getStatusBadge = (status: string) => {
    switch (status) {
      case "approved":
        return (
          <Badge variant="default" className="bg-green-500">
            ƒê√£ duy·ªát
          </Badge>
        )
      case "pending":
        return <Badge variant="secondary">Ch·ªù duy·ªát</Badge>
      case "rejected":
        return <Badge variant="destructive">T·ª´ ch·ªëi</Badge>
      default:
        return <Badge variant="outline">{status}</Badge>
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "approved":
        return <CheckCircle className="h-4 w-4 text-green-500" />
      case "pending":
        return <Clock className="h-4 w-4 text-orange-500" />
      case "rejected":
        return <XCircle className="h-4 w-4 text-red-500" />
      default:
        return <Receipt className="h-4 w-4" />
    }
  }

  // When opening detail dialog, prepare signed URLs for private files
  useEffect(() => {
    const prepareSignedUrls = async () => {
      if (!isDetailDialogOpen || !selectedRequest?.file_attachments) return
      const storagePaths = (selectedRequest.file_attachments || [])
        .map(att => att.storage_path)
        .filter(Boolean) as string[]
      if (storagePaths.length === 0) {
        setAttachmentLinks({})
        return
      }

      try {
        const res = await fetch('/api/storage/expense-attachments/signed-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paths: storagePaths })
        })
        const json = await res.json()
        const links: Record<string, string> = {}
        for (const att of selectedRequest.file_attachments || []) {
          const key = att.id || att.storage_path || att.file_name
          const url = att.storage_path ? json.urls?.[att.storage_path] : undefined
          if (key && url) links[key] = url
        }
        setAttachmentLinks(links)
      } catch (e) {
        console.error('Failed to get signed urls', e)
        setAttachmentLinks({})
      }
    }
    prepareSignedUrls()
  }, [isDetailDialogOpen, selectedRequest])

  return (
    <div className="flex-1 space-y-4 p-4 pt-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Xin c·∫•p chi ph√≠</h2>
          <p className="text-muted-foreground">
            {userRole === "Employee" && "T·∫°o v√† theo d√µi y√™u c·∫ßu chi ph√≠ c·ªßa b·∫°n"}
            {userRole === "Manager" && "Duy·ªát y√™u c·∫ßu chi ph√≠ v√† qu·∫£n l√Ω chi ph√≠ c·ªßa b·∫°n"}
            {userRole === "HR" && "Qu·∫£n l√Ω t·∫•t c·∫£ y√™u c·∫ßu chi ph√≠ trong c√¥ng ty"}
          </p>
        </div>
        
        {/* Employee Balance Display */}
        {userRole === "Employee" && employeeBalance && (
          <div className="flex items-center space-x-4">
            <Card className="w-64">
              <CardHeader className="pb-2">
                <CardTitle className="text-sm font-medium flex items-center">
                  <Wallet className="h-4 w-4 mr-2" />
                  S·ªë d∆∞ hi·ªán t·∫°i
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex items-center space-x-2">
                  {employeeBalance.current_balance > 0 ? (
                    <TrendingUp className="h-4 w-4 text-green-600" />
                  ) : employeeBalance.current_balance < 0 ? (
                    <TrendingDown className="h-4 w-4 text-red-600" />
                  ) : (
                    <Wallet className="h-4 w-4 text-gray-600" />
                  )}
                  <span className={`text-lg font-bold ${
                    employeeBalance.current_balance > 0 ? 'text-green-600' :
                    employeeBalance.current_balance < 0 ? 'text-red-600' : 'text-gray-600'
                  }`}>
                    {formatCurrency(employeeBalance.current_balance)}
                  </span>
                </div>
                <p className="text-xs text-muted-foreground mt-1">
                  T·ªïng nh·∫≠n: {formatCurrency(employeeBalance.total_received)} | 
                  T·ªïng chi: {formatCurrency(employeeBalance.total_spent)}
                </p>
              </CardContent>
            </Card>
          </div>
        )}
        <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>
          <DialogTrigger asChild>
            <Button onClick={openCreateDialog}>
              <Plus className="h-4 w-4 mr-2" />
              T·∫°o y√™u c·∫ßu m·ªõi
            </Button>
          </DialogTrigger>
          <DialogContent className="sm:max-w-[425px]">
            <DialogHeader>
              <DialogTitle>T·∫°o y√™u c·∫ßu chi ph√≠</DialogTitle>
              <DialogDescription>Nh·∫≠p th√¥ng tin chi ph√≠ c·∫ßn ƒë∆∞·ª£c ph√™ duy·ªát</DialogDescription>
            </DialogHeader>
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="category">Danh m·ª•c</Label>
                  <Select value={newRequest.category} onValueChange={(value) => setNewRequest({...newRequest, category: value})}>
                    <SelectTrigger>
                      <SelectValue placeholder="Ch·ªçn danh m·ª•c" />
                    </SelectTrigger>
                    <SelectContent>
                      {budgetCategories.length > 0 ? (
                        flattenCategories(budgetCategories).map((category) => (
                          <SelectItem key={category.id} value={category.name}>
                            <div className="flex items-center space-x-2">
                              <Badge variant="outline" className="text-xs">{category.code}</Badge>
                              <span className={`${category.level > 0 ? 'text-muted-foreground' : 'font-medium'}`}>
                                {category.displayName}
                              </span>
                            </div>
                          </SelectItem>
                        ))
                      ) : (
                        // Fallback to hardcoded categories if budget categories not loaded
                        expenseCategories.map((category) => (
                          <SelectItem key={category} value={category}>
                            {category}
                          </SelectItem>
                        ))
                      )}
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="date">Ng√†y ph√°t sinh</Label>
                  <Input
                    id="date"
                    type="date"
                    value={newRequest.date}
                    onChange={(e) => setNewRequest({...newRequest, date: e.target.value})}
                    required
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="description">M√¥ t·∫£ chi ph√≠</Label>
                <Input 
                  id="description" 
                  placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt" 
                  value={newRequest.description}
                  onChange={(e) => setNewRequest({...newRequest, description: e.target.value})}
                  required 
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="amount">S·ªë ti·ªÅn (VNƒê)</Label>
                <Input 
                  id="amount" 
                  type="number" 
                  placeholder="0" 
                  value={newRequest.amount}
                  onChange={(e) => setNewRequest({...newRequest, amount: e.target.value})}
                  required 
                  min="0" 
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="notes">Ghi ch√∫</Label>
                <Textarea 
                  id="notes" 
                  placeholder="Ghi ch√∫ th√™m (t√πy ch·ªçn)" 
                  rows={3}
                  value={newRequest.notes}
                  onChange={(e) => setNewRequest({...newRequest, notes: e.target.value})}
                />
              </div>
              <div className="space-y-2">
                <Label>ƒê√≠nh k√®m h√≥a ƒë∆°n</Label>
                <div className="border-2 border-dashed border-muted-foreground/25 rounded-lg p-4 text-center">
                  <Upload className="h-8 w-8 mx-auto mb-2 text-muted-foreground" />
                  <p className="text-sm text-muted-foreground">K√©o th·∫£ file ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
                  <p className="text-xs text-muted-foreground mt-1">PNG, JPG, PDF (t·ªëi ƒëa 10MB)</p>
                  <input
                    type="file"
                    multiple
                    className="mt-3"
                    onChange={(e) => {
                      const files = Array.from(e.target.files || [])
                      setNewRequestFiles(files)
                    }}
                  />
                  {newRequestFiles.length > 0 && (
                    <div className="text-xs text-left mt-2 space-y-1">
                      {newRequestFiles.map((f) => (
                        <div key={f.name} className="flex justify-between">
                          <span className="truncate max-w-[260px]">{f.name}</span>
                          <span className="text-muted-foreground">{(f.size / 1024).toFixed(0)} KB</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
            <DialogFooter>
              <Button type="button" variant="outline" onClick={() => setIsAddDialogOpen(false)} disabled={isSubmitting}>
                H·ªßy
              </Button>
              <Button 
                onClick={handleCreateExpenseRequest}
                disabled={isSubmitting || !newRequest.category || !newRequest.description || !newRequest.amount || !newRequest.date}
              >
                {isSubmitting ? "ƒêang g·ª≠i..." : "G·ª≠i y√™u c·∫ßu"}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>

      {/* Th√¥ng b√°o t√≠ch h·ª£p v·ªõi Financial System */}
      {(userRole === "Manager" || userRole === "HR") && (
        <div className="mb-4">
          <Alert className="border-blue-200 bg-blue-50">
            <LinkIcon className="h-4 w-4 text-blue-600" />
            <AlertTitle className="text-blue-800">T√≠ch h·ª£p v·ªõi H·ªá th·ªëng T√†i ch√≠nh</AlertTitle>
            <AlertDescription className="text-blue-700">
              Khi duy·ªát y√™u c·∫ßu chi ph√≠, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o giao d·ªãch t√†i ch√≠nh v√† c·∫≠p nh·∫≠t d·ª± to√°n ng√¢n s√°ch. 
              S·ª≠ d·ª•ng n√∫t <LinkIcon className="inline h-3 w-3" /> ƒë·ªÉ t√≠ch h·ª£p th·ªß c√¥ng c√°c y√™u c·∫ßu ƒë√£ duy·ªát.
            </AlertDescription>
          </Alert>
        </div>
      )}

      {/* Th·ªëng k√™ t·ªïng quan */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Ch·ªù duy·ªát</CardTitle>
            <Clock className="h-4 w-4 text-orange-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">{totalPending}</div>
            <p className="text-xs text-muted-foreground">Y√™u c·∫ßu c·∫ßn x·ª≠ l√Ω</p>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ƒê√£ duy·ªát</CardTitle>
            <CheckCircle className="h-4 w-4 text-green-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{totalApproved}</div>
            <p className="text-xs text-muted-foreground">Y√™u c·∫ßu ƒë∆∞·ª£c ch·∫•p nh·∫≠n</p>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">T·ª´ ch·ªëi</CardTitle>
            <XCircle className="h-4 w-4 text-red-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{totalRejected}</div>
            <p className="text-xs text-muted-foreground">Y√™u c·∫ßu b·ªã t·ª´ ch·ªëi</p>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">T·ªïng chi ph√≠</CardTitle>
            <Receipt className="h-4 w-4 text-blue-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-blue-600">{formatCurrency(totalAmount)}</div>
            <p className="text-xs text-muted-foreground">ƒê√£ ƒë∆∞·ª£c ph√™ duy·ªát</p>
          </CardContent>
        </Card>
      </div>

      {/* Danh s√°ch y√™u c·∫ßu */}
      <Card>
        <CardHeader>
          <CardTitle>Danh s√°ch y√™u c·∫ßu chi ph√≠</CardTitle>
          <CardDescription>Qu·∫£n l√Ω c√°c y√™u c·∫ßu chi ph√≠ t·ª´ nh√¢n vi√™n</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex items-center space-x-2 mb-4">
            <div className="relative flex-1">
              <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="T√¨m ki·∫øm y√™u c·∫ßu..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-8"
              />
            </div>
            <Select value={filterStatus} onValueChange={(value: any) => setFilterStatus(value)}>
              <SelectTrigger className="w-[150px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">T·∫•t c·∫£</SelectItem>
                <SelectItem value="pending">Ch·ªù duy·ªát</SelectItem>
                <SelectItem value="approved">ƒê√£ duy·ªát</SelectItem>
                <SelectItem value="rejected">T·ª´ ch·ªëi</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            {loading ? (
              <div className="text-center py-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
                <p className="text-sm text-muted-foreground mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
              </div>
            ) : filteredRequests.length > 0 ? (
              filteredRequests.map((request) => (
                <div
                  key={request.id}
                  className="flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50"
                >
                  <div className="flex items-center space-x-4">
                    {getStatusIcon(request.status)}
                    <div>
                      <div className="font-medium">{request.description}</div>
                      <div className="text-sm text-muted-foreground">
                        {request.employee?.name} ‚Ä¢ {request.category} ‚Ä¢ {new Date(request.date).toLocaleDateString("vi-VN")}
                      </div>
                      {request.notes && <div className="text-xs text-muted-foreground mt-1">{request.notes}</div>}
                    </div>
                  </div>
                  <div className="flex items-center space-x-4">
                    <div className="text-right">
                      <div className="font-bold text-red-600">{formatCurrency(request.amount)}</div>
                      <div className="text-sm text-muted-foreground">
                        G·ª≠i: {new Date(request.submitted_date).toLocaleDateString("vi-VN")}
                      </div>
                    </div>
                    {getStatusBadge(request.status)}
                    <div className="flex items-center space-x-1">
                      {request.status === "pending" && (userRole === "Manager" || userRole === "HR") && (
                        <>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => handleApprove(request.id)}
                            className="text-green-600 hover:text-green-700"
                            disabled={approvingRequestId === request.id}
                          >
                            {approvingRequestId === request.id ? (
                              <div className="h-4 w-4 animate-spin rounded-full border-2 border-green-600 border-t-transparent" />
                            ) : (
                              <CheckCircle className="h-4 w-4" />
                            )}
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => openRejectDialog(request.id)}
                            className="text-red-600 hover:text-red-700"
                            disabled={rejectingRequestIdForLoading === request.id}
                          >
                            {rejectingRequestIdForLoading === request.id ? (
                              <div className="h-4 w-4 animate-spin rounded-full border-2 border-red-600 border-t-transparent" />
                            ) : (
                              <XCircle className="h-4 w-4" />
                            )}
                          </Button>
                        </>
                      )}
                      <Button variant="ghost" size="sm" onClick={() => viewRequestDetail(request)}>
                        <Eye className="h-4 w-4" />
                      </Button>
                      {/* Show Edit button only for:
                          - Employee: can edit own pending requests
                          - Manager/HR: can edit any pending requests */}
                      {request.status === "pending" && (
                        (userRole === "Employee" && request.employee_id === currentUserId) ||
                        (userRole === "Manager" || userRole === "HR")
                      ) && (
                        <Button variant="ghost" size="sm" onClick={() => openEditDialog(request)}>
                          <Edit className="h-4 w-4" />
                        </Button>
                      )}
                      {/* Show Integrate button for approved expenses (Manager/HR only) */}
                      {request.status === "approved" && (userRole === "Manager" || userRole === "HR") && (
                        <Button variant="ghost" size="sm" onClick={() => openIntegrateDialog(request)} className="text-blue-600 hover:text-blue-700">
                          <LinkIcon className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <div className="text-center py-8 text-muted-foreground">Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu n√†o ph√π h·ª£p</div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Reject Dialog */}
      <Dialog open={isRejectDialogOpen} onOpenChange={setIsRejectDialogOpen}>
        <DialogContent className="sm:max-w-[400px]">
          <DialogHeader>
            <DialogTitle>Nh·∫≠p l√Ω do t·ª´ ch·ªëi</DialogTitle>
            <DialogDescription>Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi y√™u c·∫ßu chi ph√≠</DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <Textarea
              id="rejectionReason"
              placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..."
              value={rejectionReason}
              onChange={(e) => setRejectionReason(e.target.value)}
            />
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setIsRejectDialogOpen(false)} disabled={rejectingRequestIdForLoading === rejectingRequestId}>
              H·ªßy
            </Button>
            <Button
              onClick={() => {
                handleReject(rejectingRequestId, rejectionReason)
              }}
              disabled={rejectingRequestIdForLoading === rejectingRequestId || !rejectionReason.trim()}
            >
              {rejectingRequestIdForLoading === rejectingRequestId ? "ƒêang t·ª´ ch·ªëi..." : "T·ª´ ch·ªëi"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Detail Dialog */}
      <Dialog open={isDetailDialogOpen} onOpenChange={setIsDetailDialogOpen}>
        <DialogContent className="sm:max-w-[600px] max-h-[90vh] overflow-y-auto">
          {selectedRequest && (
            <>
              <DialogHeader>
                <DialogTitle className="flex items-center gap-3">
                  <div className="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold">
                    {selectedRequest.employee?.name
                      ?.split(" ")
                      .map((n: string) => n[0])
                      .join("")
                      .slice(0, 2) || "NV"}
                  </div>
                  <div>
                    <div className="text-xl">Y√™u c·∫ßu chi ph√≠ #{selectedRequest.id}</div>
                    <div className="text-sm text-muted-foreground font-normal">
                      {selectedRequest.employee?.name} ‚Ä¢ {selectedRequest.employee?.employee_code}
                    </div>
                  </div>
                </DialogTitle>
              </DialogHeader>

              <div className="space-y-6 max-h-[calc(90vh-200px)] overflow-y-auto pr-2">
                {/* Request Info */}
                <div className="grid gap-4 md:grid-cols-2">
                  <Card>
                    <CardHeader className="pb-3">
                      <CardTitle className="text-base">Th√¥ng tin chi ph√≠</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-sm text-gray-600">Danh m·ª•c:</span>
                        <Badge variant="outline">{selectedRequest.category}</Badge>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-sm text-gray-600">S·ªë ti·ªÅn:</span>
                        <span className="font-bold text-red-600">{formatCurrency(selectedRequest.amount)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-sm text-gray-600">Ng√†y ph√°t sinh:</span>
                        <span className="font-medium">
                          {new Date(selectedRequest.date).toLocaleDateString("vi-VN")}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-sm text-gray-600">Ng√†y g·ª≠i:</span>
                        <span className="font-medium">
                          {new Date(selectedRequest.submitted_date).toLocaleDateString("vi-VN")}
                        </span>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader className="pb-3">
                      <CardTitle className="text-base">Tr·∫°ng th√°i x·ª≠ l√Ω</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-sm text-gray-600">Tr·∫°ng th√°i:</span>
                        {getStatusBadge(selectedRequest.status)}
                      </div>
                      {selectedRequest.approved_by_employee && (
                        <div className="flex justify-between">
                          <span className="text-sm text-gray-600">Ng∆∞·ªùi duy·ªát:</span>
                          <span className="font-medium">{selectedRequest.approved_by_employee.name}</span>
                        </div>
                      )}
                      {selectedRequest.approved_date && (
                        <div className="flex justify-between">
                          <span className="text-sm text-gray-600">Ng√†y duy·ªát:</span>
                          <span className="font-medium">
                            {new Date(selectedRequest.approved_date).toLocaleDateString("vi-VN")}
                          </span>
                        </div>
                      )}
                      {selectedRequest.rejected_by_employee && (
                        <div className="flex justify-between">
                          <span className="text-sm text-gray-600">Ng∆∞·ªùi t·ª´ ch·ªëi:</span>
                          <span className="font-medium">{selectedRequest.rejected_by_employee.name}</span>
                        </div>
                      )}
                      {selectedRequest.rejected_date && (
                        <div className="flex justify-between">
                          <span className="text-sm text-gray-600">Ng√†y t·ª´ ch·ªëi:</span>
                          <span className="font-medium">
                            {new Date(selectedRequest.rejected_date).toLocaleDateString("vi-VN")}
                          </span>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </div>

                {/* Description and Notes */}
                <div className="space-y-4">
                  <div>
                    <Label className="text-sm font-medium text-gray-700">M√¥ t·∫£ chi ph√≠:</Label>
                    <div className="mt-1 p-3 bg-gray-50 rounded-lg text-sm break-words">{selectedRequest.description}</div>
                  </div>

                  {selectedRequest.notes && (
                    <div>
                      <Label className="text-sm font-medium text-gray-700">Ghi ch√∫:</Label>
                      <div className="mt-1 p-3 bg-gray-50 rounded-lg text-sm break-words">{selectedRequest.notes}</div>
                    </div>
                  )}

                  {selectedRequest.rejection_reason && (
                    <div>
                      <Label className="text-sm font-medium text-red-700">L√Ω do t·ª´ ch·ªëi:</Label>
                      <div className="mt-1 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 break-words">
                        {selectedRequest.rejection_reason}
                      </div>
                    </div>
                  )}

                  {/* Attachments */}
                  <div>
                    <Label className="text-sm font-medium text-gray-700">T·ªáp ƒë√≠nh k√®m:</Label>
                    <div className="mt-2 space-y-2">
                      {/* New JSON attachments */}
                      {(selectedRequest.file_attachments && selectedRequest.file_attachments.length > 0) ? (
                        selectedRequest.file_attachments.map((att) => {
                          const key = att.id || att.storage_path || att.file_name
                          const url = key ? attachmentLinks[key] : undefined
                          return (
                            <div key={key} className="flex items-center justify-between rounded border p-3 hover:bg-gray-50">
                              <div className="flex-1 min-w-0 mr-3">
                                <div className="text-sm font-medium truncate" title={att.file_name}>
                                  {att.file_name}
                                </div>
                                {att.file_size && (
                                  <div className="text-xs text-muted-foreground">
                                    {(att.file_size / 1024).toFixed(1)} KB
                                  </div>
                                )}
                              </div>
                              <div className="flex items-center gap-2 flex-shrink-0">
                                {url ? (
                                  <a href={url} target="_blank" rel="noopener noreferrer">
                                    <Button size="sm" variant="secondary">Xem</Button>
                                  </a>
                                ) : (
                                  <span className="text-xs text-muted-foreground">ƒêang t·∫°o link...</span>
                                )}
                              </div>
                            </div>
                          )
                        })
                      ) : (
                        // Legacy attachments (string URLs)
                        (selectedRequest.attachments && selectedRequest.attachments.length > 0) ? (
                          selectedRequest.attachments.map((url) => (
                            <div key={url} className="flex items-center justify-between rounded border p-3 hover:bg-gray-50">
                              <div className="flex-1 min-w-0 mr-3">
                                <div className="text-sm truncate" title={url}>{url}</div>
                              </div>
                              <a href={url} target="_blank" rel="noopener noreferrer" className="flex-shrink-0">
                                <Button size="sm" variant="secondary">Xem</Button>
                              </a>
                            </div>
                          ))
                        ) : (
                          <div className="text-sm text-muted-foreground">Ch∆∞a c√≥ t·ªáp ƒë√≠nh k√®m</div>
                        )
                      )}
                    </div>
                  </div>
                </div>


              </div>

              {/* Approval Actions - Fixed at bottom */}
              {(userRole === "Manager" || userRole === "HR") &&
                selectedRequest.status === "pending" && (
                  <div className="flex gap-3 pt-4 border-t bg-white">
                    <Button
                      onClick={() => {
                        handleApprove(selectedRequest.id)
                        setIsDetailDialogOpen(false)
                      }}
                      className="flex-1"
                      disabled={approvingRequestId === selectedRequest.id}
                    >
                      {approvingRequestId === selectedRequest.id ? (
                        <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent mr-2" />
                      ) : (
                        <CheckCircle className="mr-2 h-4 w-4" />
                      )}
                      Ph√™ duy·ªát
                    </Button>
                    <Button
                      variant="destructive"
                      onClick={() => {
                        openRejectDialog(selectedRequest.id)
                        setIsDetailDialogOpen(false)
                      }}
                      className="flex-1"
                      disabled={rejectingRequestIdForLoading === selectedRequest.id}
                    >
                      {rejectingRequestIdForLoading === selectedRequest.id ? (
                        <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent mr-2" />
                      ) : (
                        <XCircle className="mr-2 h-4 w-4" />
                      )}
                      T·ª´ ch·ªëi
                    </Button>
                  </div>
                )}
            </>
          )}
        </DialogContent>
      </Dialog>

      {/* Edit Dialog */}
      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>Ch·ªânh s·ª≠a y√™u c·∫ßu chi ph√≠</DialogTitle>
            <DialogDescription>C·∫≠p nh·∫≠t th√¥ng tin y√™u c·∫ßu chi ph√≠</DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="edit-category">Danh m·ª•c</Label>
                <Select value={editRequest.category} onValueChange={(value) => setEditRequest({...editRequest, category: value})}>
                  <SelectTrigger>
                    <SelectValue placeholder="Ch·ªçn danh m·ª•c" />
                  </SelectTrigger>
                  <SelectContent>
                    {budgetCategories.length > 0 ? (
                      flattenCategories(budgetCategories).map((category) => (
                        <SelectItem key={category.id} value={category.name}>
                          <div className="flex items-center space-x-2">
                            <Badge variant="outline" className="text-xs">{category.code}</Badge>
                            <span className={`${category.level > 0 ? 'text-muted-foreground' : 'font-medium'}`}>
                              {category.displayName}
                            </span>
                          </div>
                        </SelectItem>
                      ))
                    ) : (
                      // Fallback to hardcoded categories if budget categories not loaded
                      expenseCategories.map((category) => (
                        <SelectItem key={category} value={category}>
                          {category}
                        </SelectItem>
                      ))
                    )}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label htmlFor="edit-date">Ng√†y ph√°t sinh</Label>
                <Input
                  id="edit-date"
                  type="date"
                  value={editRequest.date}
                  onChange={(e) => setEditRequest({...editRequest, date: e.target.value})}
                  required
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label htmlFor="edit-description">M√¥ t·∫£ chi ph√≠</Label>
              <Input 
                id="edit-description" 
                placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt" 
                value={editRequest.description}
                onChange={(e) => setEditRequest({...editRequest, description: e.target.value})}
                required 
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="edit-amount">S·ªë ti·ªÅn (VNƒê)</Label>
              <Input 
                id="edit-amount" 
                type="number" 
                placeholder="0" 
                value={editRequest.amount}
                onChange={(e) => setEditRequest({...editRequest, amount: e.target.value})}
                required 
                min="0" 
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="edit-notes">Ghi ch√∫</Label>
              <Textarea 
                id="edit-notes" 
                placeholder="Ghi ch√∫ th√™m (t√πy ch·ªçn)" 
                rows={3}
                value={editRequest.notes}
                onChange={(e) => setEditRequest({...editRequest, notes: e.target.value})}
              />
            </div>
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={() => setIsEditDialogOpen(false)}>
              H·ªßy
            </Button>
            <Button onClick={handleUpdateRequest}>C·∫≠p nh·∫≠t</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Integrate with Financial Dialog */}
      <Dialog open={isIntegrateDialogOpen} onOpenChange={setIsIntegrateDialogOpen}>
        <DialogContent className="sm:max-w-[500px]">
          <DialogHeader>
            <DialogTitle className="flex items-center space-x-2">
              <LinkIcon className="w-5 h-5" />
              <span>T√≠ch h·ª£p v·ªõi H·ªá th·ªëng T√†i ch√≠nh</span>
            </DialogTitle>
            <DialogDescription>
              T√≠ch h·ª£p y√™u c·∫ßu chi ph√≠ ƒë√£ duy·ªát v·ªõi h·ªá th·ªëng qu·∫£n l√Ω t√†i ch√≠nh v√† ng√¢n s√°ch
            </DialogDescription>
          </DialogHeader>
          
          {integratingRequest && (
            <div className="space-y-4">
              {/* Expense Info */}
              <div className="p-4 border rounded-lg bg-gray-50">
                <h4 className="font-medium text-sm text-gray-700 mb-2">Th√¥ng tin y√™u c·∫ßu chi ph√≠</h4>
                <div className="space-y-1 text-sm">
                  <div><strong>M√¥ t·∫£:</strong> {integratingRequest.description}</div>
                  <div><strong>S·ªë ti·ªÅn:</strong> {formatCurrency(integratingRequest.amount)}</div>
                  <div><strong>Danh m·ª•c:</strong> {integratingRequest.category}</div>
                  <div><strong>Nh√¢n vi√™n:</strong> {integratingRequest.employee?.name}</div>
                </div>
              </div>

              {/* Budget Category Selection */}
              <div className="space-y-2">
                <Label htmlFor="budget_category">Danh m·ª•c Ng√¢n s√°ch (t√πy ch·ªçn)</Label>
                <Select value={selectedBudgetCategory} onValueChange={setSelectedBudgetCategory}>
                  <SelectTrigger>
                    <SelectValue placeholder="Ch·ªçn danh m·ª•c ng√¢n s√°ch ƒë·ªÉ theo d√µi" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">Kh√¥ng ch·ªçn danh m·ª•c</SelectItem>
                    {budgetCategories.length > 0 ? (
                      flattenCategories(budgetCategories).map((category) => (
                        <SelectItem key={category.id} value={category.id}>
                          <div className="flex items-center space-x-2">
                            <Badge variant="outline" className="text-xs">{category.code}</Badge>
                            <span className={`${category.level > 0 ? 'text-muted-foreground' : 'font-medium'}`}>
                              {category.displayName}
                            </span>
                          </div>
                        </SelectItem>
                      ))
                    ) : (
                      <SelectItem value="loading" disabled>
                        ƒêang t·∫£i danh m·ª•c...
                      </SelectItem>
                    )}
                  </SelectContent>
                </Select>
                <p className="text-xs text-muted-foreground">
                  Ch·ªçn danh m·ª•c ng√¢n s√°ch ƒë·ªÉ theo d√µi chi ph√≠ n√†y trong h·ªá th·ªëng ng√¢n s√°ch chi ti·∫øt
                </p>
              </div>

              {/* Integration Actions */}
              <div className="p-4 border-l-4 border-blue-500 bg-blue-50">
                <h4 className="font-medium text-blue-800 mb-2">T√≠ch h·ª£p s·∫Ω th·ª±c hi·ªán:</h4>
                <ul className="text-sm text-blue-700 space-y-1">
                  <li>‚Ä¢ T·∫°o giao d·ªãch t√†i ch√≠nh t·ª± ƒë·ªông trong h·ªá th·ªëng</li>
                  <li>‚Ä¢ C·∫≠p nh·∫≠t s·ªë li·ªáu chi ph√≠ th·ª±c t·∫ø</li>
                  <li>‚Ä¢ Li√™n k·∫øt v·ªõi danh m·ª•c ng√¢n s√°ch (n·∫øu ƒë∆∞·ª£c ch·ªçn)</li>
                  <li>‚Ä¢ Theo d√µi ti·∫øn ƒë·ªô s·ª≠ d·ª•ng ng√¢n s√°ch</li>
                </ul>
              </div>
            </div>
          )}

          <DialogFooter>
            <Button variant="outline" onClick={() => setIsIntegrateDialogOpen(false)} disabled={isIntegrating}>
              H·ªßy
            </Button>
            <Button onClick={handleIntegrateWithFinancial} disabled={isIntegrating}>
              {isIntegrating ? (
                <div className="flex items-center space-x-2">
                  <div className="w-4 h-4 animate-spin rounded-full border-2 border-white border-t-transparent" />
                  <span>ƒêang t√≠ch h·ª£p...</span>
                </div>
              ) : (
                <div className="flex items-center space-x-2">
                  <LinkIcon className="w-4 h-4" />
                  <span>T√≠ch h·ª£p ngay</span>
                </div>
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  )
}
